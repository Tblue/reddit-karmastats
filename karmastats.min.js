// (c) 2011 by Tilman Blumenbach
// Licensed under the BSD 3-clause license: http://opensource.org/licenses/BSD-3-Clause
// For the full license and source code, see karmastats.js in this directory.
var KarmaStats=function(){$("#interface").show();$("#karmaform").submit($.proxy(this,"analyzeUser"));$("#username").focus();if(document.location.hash!==""){var a=document.location.hash.substr(1);$("#username").val(a);$("#karmaform").submit()}};
KarmaStats.prototype={limit:100,cache_url:"cache.php",cache_prefix:"karmastats_",errorTimeoutHandler:void 0,username:void 0,url:void 0,count:0,after:void 0,all:{},comments:{},submissions:{},reset:function(a){this.count=0;this.after=void 0;this.all={};this.comments={};this.submissions={};if(!(typeof a!="undefined"&&a))this.url=this.username=void 0},showError:function(a,c){typeof c!="undefined"&&c?($("#username").addClass("errorfield"),$("#formerror").html(a)):$("#result").html('<div id="status"><p class="message error">'+
a+"</p></div>")},clearError:function(a){typeof a!="undefined"&&a?($("#username").removeClass("errorfield"),$("#formerror").empty()):$("#result").empty()},setStatus:function(a,c){var b=typeof c!="undefined"&&c?"warning":"status";$("#result").html('<div id="status"><img alt="Wait..." src="throbber.gif"><p class="message '+b+'">'+a+"</p></div>")},installErrorTimeoutHandler:function(){this.removeErrorTimeoutHandler();this.errorTimeoutHandler=setTimeout($.proxy(function(){this.setStatus("No data received yet! Maybe the user does not exist or reddit is overloaded? We will keep on trying...",
!0)},this),5E3)},removeErrorTimeoutHandler:function(){if(this.errorTimeoutHandler==void 0)return!1;clearTimeout(this.errorTimeoutHandler);return!0},analyzeUser:function(){this.clearError();this.clearError(!0);$("#sharelink").hide();this.reset();this.username=$.trim($("#username").val()).toLowerCase();if(this.username==="")return this.showError("Empty username. Try again.",!0),!1;document.location.hash="#"+escape(this.username);this.checkCache();return!1},checkCache:function(){this.setStatus("Checking cache...");
$.ajax(this.cache_url,{data:{key:this.cache_prefix+this.username,nonce:karmastats_nonce},dataType:"json",context:this,error:function(){this.gatherData()},success:function(a){try{this.all=a.all,this.comments=a.comments,this.submissions=a.submissions}catch(c){if(typeof c=="object"&&typeof c.name!="undefined"&&c.name=="TypeError"){this.reset(!0);this.gatherData();return}throw c;}this.drawAllCharts()}})},gatherData:function(){this.setStatus("Fetching datasets (got 0 so far)...");this.url="http://www.reddit.com/user/"+
escape(this.username)+"/.json?limit="+this.limit;$.ajax(this.url,{dataType:"jsonp",jsonp:"jsonp",context:this,success:this.dataLoaded});this.installErrorTimeoutHandler()},dataLoaded:function(a){this.removeErrorTimeoutHandler();try{var c=a.data.children;this.after=a.data.after;this.count+=c.length;for(k in c){var b=c[k],d;if(b.kind=="t1")d=this.comments;else if(b.kind=="t3")d=this.submissions;else continue;if(typeof b.data.score=="undefined")b.data.score=b.data.ups-b.data.downs;typeof d[b.data.subreddit]==
"undefined"&&(d[b.data.subreddit]=0);d[b.data.subreddit]+=b.data.score;typeof this.all[b.data.subreddit]=="undefined"&&(this.all[b.data.subreddit]=0);this.all[b.data.subreddit]+=b.data.score}}catch(e){if(typeof e=="object"&&typeof e.name!="undefined"&&e.name=="TypeError"){this.showError("Received malformed data!");return}throw e;}this.after===null?(this.drawAllCharts(),a=$.param({all:this.all,comments:this.comments,submissions:this.submissions}),$.ajax(this.cache_url,{type:"POST",data:{key:this.cache_prefix+
this.username,nonce:karmastats_nonce,data:a},dataType:"json",context:this})):(this.setStatus("Fetching datasets (got "+this.count+" so far)..."),setTimeout($.proxy(function(){$.ajax(this.url,{data:{count:this.count,after:this.after},dataType:"jsonp",jsonp:"jsonp",context:this,success:this.dataLoaded});this.installErrorTimeoutHandler()},this),2E3))},drawChart:function(a,c,b,d,e){var f=new google.visualization.DataTable;f.addColumn("string","Subreddit");var j=f.addColumn("number","Karma"),h=0;for(s in a){var i=
s,g=Number(a[s]);h+=g;g<0&&(g=-g,i+=" (negative)");f.addRow([i,g])}f.sort(j);(new google.visualization.PieChart(e)).draw(f,{title:c+" ("+h+" points)",width:b,height:d,reverseCategories:!0})},drawAllCharts:function(){this.setStatus("Generating charts...");$("#result").append('<div id="charts" style="display: none;"><table><tr><td><div id="submissions"></div></td><td><div id="comments"></div></td></tr><tr><td colspan="2"><div id="all"></div></td></tr></table></div>');window.innerWidth>=1240?($("#result").css("width",
"1240px"),chart_width=620,chart_height=420):($("#result").css("width","1000px"),chart_width=500,chart_height=300);this.drawChart(this.submissions,"Submission karma",chart_width,chart_height,document.getElementById("submissions"));this.drawChart(this.comments,"Comment karma",chart_width,chart_height,document.getElementById("comments"));this.drawChart(this.all,"Total karma",chart_width,chart_height,document.getElementById("all"));$("#status").hide();$("#charts").show();var a=document.location.href.replace(/[?#].*?$/,
"");a+="#"+escape(this.username);$("#sharelink").html('Want to share these statistics? Point your friends to <a href="'+a+'">'+a+"</a>.").show()}};
